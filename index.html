<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Deriv Pro Trader - Martingale Bot</title>
  <style>
    :root {
      --primary: #6366f1;
      --primary-light: #818cf8;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --background: #ffffff;
      --card: #f8fafc;
      --text: #1e293b;
      --text-light: #64748b;
      --border: #e2e8f0;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: var(--text);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }
    
    /* Candlestick Background */
    .candlestick-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.2) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
      z-index: -1;
    }
    
    .candlestick {
      position: absolute;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }
    
    .logo {
      font-size: 48px;
      font-weight: 900;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }
    
    .subtitle {
      font-size: 18px;
      color: var(--text-light);
      font-weight: 500;
    }
    
    .dashboard {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .panel {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .trading-view {
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 20px;
    }
    
    .price-section {
      text-align: center;
    }
    
    .price-display {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 72px;
      font-weight: 900;
      color: white;
      box-shadow: 0 12px 40px rgba(99, 102, 241, 0.3);
      transition: all 0.3s ease;
      border: 8px solid rgba(255, 255, 255, 0.9);
    }
    
    .price-win {
      background: linear-gradient(135deg, var(--success), #34d399);
      box-shadow: 0 12px 40px rgba(16, 185, 129, 0.3);
    }
    
    .price-loss {
      background: linear-gradient(135deg, var(--danger), #f87171);
      box-shadow: 0 12px 40px rgba(239, 68, 68, 0.3);
    }
    
    .market-info {
      font-size: 24px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 10px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin: 20px 0;
    }
    
    .stat-card {
      background: var(--card);
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      border: 1px solid var(--border);
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--text-light);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .controls-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }
    
    input, select {
      width: 100%;
      padding: 15px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: white;
      color: var(--text);
      font-size: 16px;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .btn {
      padding: 18px 24px;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }
    
    .btn-success {
      background: linear-gradient(135deg, var(--success), #34d399);
      color: white;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, var(--danger), #f87171);
      color: white;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }
    
    .status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 600;
    }
    
    .status-connected {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
      border: 2px solid rgba(16, 185, 129, 0.2);
    }
    
    .status-disconnected {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border: 2px solid rgba(239, 68, 68, 0.2);
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .status-connected .status-dot {
      background: var(--success);
      animation: pulse 2s infinite;
    }
    
    .status-disconnected .status-dot {
      background: var(--danger);
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .strategy-card {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(129, 140, 248, 0.1));
      border: 2px solid rgba(99, 102, 241, 0.2);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .strategy-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 10px;
    }
    
    .strategy-desc {
      font-size: 14px;
      color: var(--text);
      line-height: 1.5;
    }
    
    .martingale-info {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(251, 191, 36, 0.1));
      border: 2px solid rgba(245, 158, 11, 0.2);
      border-radius: 15px;
      padding: 15px;
      margin: 15px 0;
    }
    
    .martingale-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--warning);
      margin-bottom: 8px;
    }
    
    .log-section {
      background: var(--card);
      border-radius: 15px;
      padding: 20px;
      border: 1px solid var(--border);
    }
    
    .log-header {
      font-size: 16px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .log-content {
      height: 300px;
      overflow-y: auto;
      font-size: 14px;
      line-height: 1.4;
    }
    
    .log-entry {
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .log-time {
      color: var(--text-light);
      font-size: 12px;
      font-weight: 600;
      min-width: 70px;
    }
    
    .log-message {
      color: var(--text);
      flex: 1;
    }
    
    .log-trade {
      color: var(--primary);
      font-weight: 600;
    }
    
    .log-win {
      color: var(--success);
      font-weight: 600;
    }
    
    .log-loss {
      color: var(--danger);
      font-weight: 600;
    }
    
    .reentry-badge {
      background: var(--warning);
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
    }
    
    /* Responsive Design */
    @media (max-width: 1024px) {
      .dashboard {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .panel {
        padding: 20px;
      }
      
      .price-display {
        width: 150px;
        height: 150px;
        font-size: 48px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .controls-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Candlestick Background -->
  <div class="candlestick-bg" id="candlestickBg"></div>
  
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="logo">DERIV PRO</div>
      <div class="subtitle">Advanced Martingale Trading Bot with Immediate Re-entry</div>
    </div>
    
    <!-- Main Dashboard -->
    <div class="dashboard">
      <!-- Left Panel - Trading View -->
      <div class="panel trading-view">
        <!-- Price Display Section -->
        <div class="price-section">
          <div class="price-display" id="priceDisplay">-</div>
          <div class="market-info" id="marketInfo">Volatility 10 Index</div>
          <div class="status" id="connectionStatus">
            <div class="status-dot"></div>
            <span>Disconnected</span>
          </div>
        </div>
        
        <!-- Statistics Grid -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalProfit">$0.00</div>
            <div class="stat-label">Total Profit & Loss</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalTrades">0</div>
            <div class="stat-label">Total Trades</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="winRate">0%</div>
            <div class="stat-label">Win Rate</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="currentStake">$0.35</div>
            <div class="stat-label">Current Stake</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="lossStreak">0</div>
            <div class="stat-label">Loss Streak</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="reentryCount">0/5</div>
            <div class="stat-label">Re-entries Used</div>
          </div>
        </div>
        
        <!-- Trading Log -->
        <div class="log-section">
          <div class="log-header">
            <span>Live Trading Activity</span>
            <span id="patternProgress">Pattern: 0/2</span>
          </div>
          <div class="log-content" id="tradingLog">
            <div class="log-entry">
              <span class="log-time">[00:00:00]</span>
              <span class="log-message">Welcome to Deriv Pro Trader! Configure your strategy and start trading.</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Right Panel - Controls -->
      <div class="panel">
        <!-- API Connection -->
        <div class="form-group">
          <label for="apiToken">Deriv API Token</label>
          <input type="password" id="apiToken" placeholder="Enter your API token">
        </div>
        
        <!-- Market Selection -->
        <div class="form-group">
          <label for="marketSelect">Trading Market</label>
          <select id="marketSelect">
            <option value="R_10">Volatility 10 Index</option>
            <option value="R_25">Volatility 25 Index</option>
            <option value="R_50">Volatility 50 Index</option>
            <option value="R_75">Volatility 75 Index</option>
            <option value="R_100">Volatility 100 Index</option>
            <option value="1HZ10V">Volatility 10 (1s)</option>
            <option value="1HZ100V">Volatility 100 (1s)</option>
          </select>
        </div>
        
        <!-- Trading Strategy -->
        <div class="form-group">
          <label>Trading Strategy</label>
          <div class="controls-grid">
            <select id="tradeDirection">
              <option value="DIGITOVER">Over</option>
              <option value="DIGITUNDER">Under</option>
            </select>
            <select id="tradeBarrier">
              <option value="2">Digit 2</option>
              <option value="3">Digit 3</option>
              <option value="4">Digit 4</option>
              <option value="5">Digit 5</option>
              <option value="6">Digit 6</option>
              <option value="7">Digit 7</option>
              <option value="8">Digit 8</option>
            </select>
          </div>
        </div>
        
        <!-- Pattern Settings -->
        <div class="form-group">
          <label>Pattern Detection</label>
          <div class="controls-grid">
            <input type="number" id="patternCount" value="2" min="1" max="5" placeholder="Consecutive Count">
            <select id="patternType">
              <option value="opposite">Opposite Pattern</option>
            </select>
          </div>
        </div>
        
        <!-- Stake Management -->
        <div class="form-group">
          <label>Stake Settings ($)</label>
          <div class="controls-grid">
            <input type="number" id="baseStake" value="0.35" min="0.35" step="0.01" placeholder="Base Stake">
            <input type="number" id="maxStake" value="10.00" min="1.00" step="0.01" placeholder="Max Stake">
          </div>
        </div>
        
        <!-- Risk Management -->
        <div class="form-group">
          <label>Risk Management ($)</label>
          <div class="controls-grid">
            <input type="number" id="profitTarget" value="5.00" min="1.00" step="0.01" placeholder="Profit Target">
            <input type="number" id="stopLoss" value="10.00" min="1.00" step="0.01" placeholder="Stop Loss">
          </div>
        </div>
        
        <!-- Martingale Settings -->
        <div class="martingale-info">
          <div class="martingale-title">‚ö° Martingale Re-entry System</div>
          <div style="font-size: 12px; color: var(--text-light);">
            Immediate re-entry on loss with 2x stake increase. Max 5 re-entries.
          </div>
        </div>
        
        <!-- Strategy Info -->
        <div class="strategy-card">
          <div class="strategy-title">üéØ Active Strategy</div>
          <div class="strategy-desc">
            Trade <strong id="currentTradeType">Over 2</strong> after 
            <strong id="currentPatternCount">2</strong> consecutive 
            <strong id="currentPatternType">Under 2</strong> patterns
          </div>
        </div>
        
        <!-- Control Buttons -->
        <div class="controls-grid" style="margin-top: 20px;">
          <button class="btn btn-success" onclick="startTrading()">
            <span>‚ñ∂Ô∏è</span> Start Trading
          </button>
          <button class="btn btn-danger" onclick="stopTrading()">
            <span>‚èπÔ∏è</span> Stop Trading
          </button>
        </div>
        <button class="btn btn-primary" style="margin-top: 10px; width: 100%;" onclick="testTrade()">
          <span>üîß</span> Test Single Trade
        </button>
      </div>
    </div>
  </div>

  <script>
    // Trading Bot State
    const state = {
      ws: null,
      isConnected: false,
      isTrading: false,
      token: '',
      market: 'R_10',
      tradeType: 'DIGITOVER',
      barrier: 2,
      patternCount: 2,
      baseStake: 0.35,
      currentStake: 0.35,
      totalProfit: 0,
      totalTrades: 0,
      wins: 0,
      losses: 0,
      lossStreak: 0,
      consecutiveLosses: 0,
      maxReentries: 5,
      currentReentries: 0,
      patternProgress: 0,
      recentDigits: [],
      waitingForResult: false,
      contractId: null,
      lastLossDigit: null
    };

    // Initialize candlestick background
    function initCandlestickBackground() {
      const bg = document.getElementById('candlestickBg');
      for (let i = 0; i < 50; i++) {
        const candle = document.createElement('div');
        candle.className = 'candlestick';
        candle.style.width = Math.random() * 4 + 2 + 'px';
        candle.style.height = Math.random() * 100 + 20 + 'px';
        candle.style.left = Math.random() * 100 + '%';
        candle.style.top = Math.random() * 100 + '%';
        candle.style.opacity = Math.random() * 0.3 + 0.1;
        bg.appendChild(candle);
      }
    }

    // Update Statistics Display
    function updateStats() {
      document.getElementById('totalProfit').textContent = `$${state.totalProfit.toFixed(2)}`;
      document.getElementById('totalTrades').textContent = state.totalTrades;
      document.getElementById('currentStake').textContent = `$${state.currentStake.toFixed(2)}`;
      document.getElementById('lossStreak').textContent = state.lossStreak;
      document.getElementById('reentryCount').textContent = `${state.currentReentries}/${state.maxReentries}`;
      document.getElementById('patternProgress').textContent = `Pattern: ${state.patternProgress}/${state.patternCount}`;
      
      const winRate = state.totalTrades > 0 ? ((state.wins / state.totalTrades) * 100).toFixed(1) : 0;
      document.getElementById('winRate').textContent = `${winRate}%`;
      
      // Update strategy display
      const oppositeType = state.tradeType === 'DIGITOVER' ? 'Under' : 'Over';
      document.getElementById('currentTradeType').textContent = `${state.tradeType === 'DIGITOVER' ? 'Over' : 'Under'} ${state.barrier}`;
      document.getElementById('currentPatternCount').textContent = state.patternCount;
      document.getElementById('currentPatternType').textContent = `${oppositeType} ${state.barrier}`;
      
      // Update market info
      document.getElementById('marketInfo').textContent = 
        document.getElementById('marketSelect').selectedOptions[0].text;
    }

    // Add log message
    function addLog(message, type = 'info') {
      const time = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry';
      
      let messageClass = 'log-message';
      if (type === 'trade') messageClass = 'log-trade';
      else if (type === 'win') messageClass = 'log-win';
      else if (type === 'loss') messageClass = 'log-loss';
      
      logEntry.innerHTML = `
        <span class="log-time">[${time}]</span>
        <span class="${messageClass}">${message}</span>
      `;
      
      document.getElementById('tradingLog').appendChild(logEntry);
      document.getElementById('tradingLog').scrollTop = document.getElementById('tradingLog').scrollHeight;
    }

    // Update price display
    function updatePriceDisplay(digit, type = 'normal') {
      const display = document.getElementById('priceDisplay');
      display.textContent = digit;
      display.className = 'price-display';
      
      if (type === 'win') {
        display.classList.add('price-win');
      } else if (type === 'loss') {
        display.classList.add('price-loss');
      }
    }

    // Update connection status
    function updateConnectionStatus(connected) {
      const status = document.getElementById('connectionStatus');
      if (connected) {
        status.className = 'status status-connected';
        status.innerHTML = '<div class="status-dot"></div><span>Connected</span>';
      } else {
        status.className = 'status status-disconnected';
        status.innerHTML = '<div class="status-dot"></div><span>Disconnected</span>';
      }
    }

    // WebSocket Connection
    function connectWebSocket() {
      try {
        state.ws = new WebSocket('wss://ws.derivws.com/websockets/v3?app_id=1089');
        
        state.ws.onopen = () => {
          state.isConnected = true;
          updateConnectionStatus(true);
          addLog('WebSocket connected. Authorizing...', 'info');
          
          state.ws.send(JSON.stringify({
            authorize: state.token
          }));
        };
        
        state.ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          handleWebSocketMessage(data);
        };
        
        state.ws.onclose = () => {
          state.isConnected = false;
          updateConnectionStatus(false);
          addLog('WebSocket disconnected', 'info');
          
          if (state.isTrading) {
            setTimeout(connectWebSocket, 2000);
          }
        };
        
        state.ws.onerror = (error) => {
          addLog('WebSocket error occurred', 'info');
        };
        
      } catch (error) {
        addLog('Failed to connect to WebSocket', 'info');
      }
    }

    // Handle WebSocket messages
    function handleWebSocketMessage(data) {
      if (data.msg_type === 'authorize') {
        if (data.authorize) {
          addLog('Successfully authorized with Deriv', 'info');
          state.ws.send(JSON.stringify({
            ticks: state.market,
            subscribe: 1
          }));
        } else {
          addLog('Authorization failed - check your API token', 'info');
        }
        return;
      }
      
      if (data.msg_type === 'tick') {
        const digit = parseInt(data.tick.quote.toString().slice(-1));
        handleNewTick(digit);
        return;
      }
      
      if (data.msg_type === 'proposal') {
        if (data.proposal) {
          const proposalId = data.proposal.id;
          addLog(`Proposal received, buying contract...`, 'trade');
          
          state.ws.send(JSON.stringify({
            buy: proposalId,
            price: data.proposal.ask_price
          }));
        }
        return;
      }
      
      if (data.msg_type === 'buy') {
        if (data.buy) {
          state.contractId = data.buy.contract_id;
          addLog(`Contract purchased (ID: ${state.contractId})`, 'trade');
          
          state.ws.send(JSON.stringify({
            proposal_open_contract: 1,
            contract_id: state.contractId,
            subscribe: 1
          }));
        }
        return;
      }
      
      if (data.msg_type === 'proposal_open_contract') {
        const contract = data.proposal_open_contract;
        if (contract.is_sold) {
          const profit = parseFloat(contract.profit);
          let entryDigit = null;
          
          if (contract.entry_tick) {
            try { 
              entryDigit = parseInt(String(contract.entry_tick).slice(-1)); 
            } catch(e) { 
              entryDigit = null; 
            }
          }
          
          if (entryDigit === null && state.recentDigits.length > 0) {
            entryDigit = state.recentDigits[state.recentDigits.length - 1];
          }
          
          handleTradeResult(profit, entryDigit);
        }
        return;
      }
      
      if (data.error) {
        addLog(`Error: ${data.error.message}`, 'info');
        state.waitingForResult = false;
      }
    }

    // Handle new tick data
    function handleNewTick(digit) {
      state.recentDigits.push(digit);
      if (state.recentDigits.length > 50) state.recentDigits.shift();
      
      updatePriceDisplay(digit);
      addLog(`Tick: ${digit} | Recent: ${state.recentDigits.slice(-5).join(', ')}`, 'info');
      
      if (!state.isTrading || state.waitingForResult) return;
      
      // Check for immediate re-entry (Martingale)
      if (state.lastLossDigit !== null && digit === state.lastLossDigit) {
        addLog(`‚ö° MARTINGALE RE-ENTRY! Digit ${digit} matches last loss`, 'trade');
        state.lastLossDigit = null;
        placeTrade('MARTINGALE_REENTRY');
        return;
      }
      
      // Normal pattern detection
      const oppositeType = state.tradeType === 'DIGITOVER' ? 'DIGITUNDER' : 'DIGITOVER';
      const matchesPattern = checkPatternCondition(digit, oppositeType, state.barrier);
      
      if (matchesPattern) {
        state.patternProgress++;
        addLog(`Pattern matched! Progress: ${state.patternProgress}/${state.patternCount}`, 'info');
      } else {
        state.patternProgress = 0;
      }
      
      if (state.patternProgress >= state.patternCount) {
        addLog(`üéØ PATTERN COMPLETE! Placing ${state.tradeType === 'DIGITOVER' ? 'Over' : 'Under'} ${state.barrier} trade`, 'trade');
        state.patternProgress = 0;
        placeTrade('PATTERN');
      }
      
      updateStats();
    }

    // Check pattern condition
    function checkPatternCondition(digit, patternType, barrier) {
      if (patternType === 'DIGITUNDER') {
        return digit < barrier;
      } else if (patternType === 'DIGITOVER') {
        return digit > barrier;
      }
      return false;
    }

    // Place a trade
    function placeTrade(reason = 'PATTERN') {
      if (!state.isConnected || state.waitingForResult) return;
      
      state.waitingForResult = true;
      
      const proposalRequest = {
        proposal: 1,
        amount: state.currentStake,
        basis: "stake",
        contract_type: state.tradeType,
        currency: "USD",
        duration: 5,
        duration_unit: "t",
        symbol: state.market,
        barrier: state.barrier.toString()
      };
      
      state.ws.send(JSON.stringify(proposalRequest));
      
      const tradeTypeText = state.tradeType === 'DIGITOVER' ? 'Over' : 'Under';
      let logMessage = `Placing ${tradeTypeText} ${state.barrier} | Stake: $${state.currentStake.toFixed(2)}`;
      
      if (reason === 'MARTINGALE_REENTRY') {
        logMessage = `‚ö° ${logMessage} [MARTINGALE RE-ENTRY #${state.currentReentries}]`;
      }
      
      addLog(logMessage, 'trade');
    }

    // Handle trade result with immediate Martingale re-entry
    function handleTradeResult(profit, entryDigit) {
      state.waitingForResult = false;
      state.totalTrades++;
      state.totalProfit += profit;
      
      if (profit > 0) {
        // WIN
        state.wins++;
        state.lossStreak = 0;
        state.consecutiveLosses = 0;
        state.currentReentries = 0;
        state.lastLossDigit = null;
        state.currentStake = state.baseStake;
        
        updatePriceDisplay(entryDigit || '-', 'win');
        addLog(`‚úÖ WIN! Profit: +$${profit.toFixed(2)} | Total: $${state.totalProfit.toFixed(2)} | Reset stake to $${state.baseStake.toFixed(2)}`, 'win');
      } else {
        // LOSS - Immediate Martingale re-entry setup
        state.losses++;
        state.lossStreak++;
        state.consecutiveLosses++;
        state.currentReentries++;
        
        // Store the digit that caused the loss for immediate re-entry
        if (entryDigit !== null) {
          state.lastLossDigit = entryDigit;
          addLog(`‚ùå LOSS! Digit: ${entryDigit} | Profit: $${profit.toFixed(2)} | Next stake: $${(state.currentStake * 2).toFixed(2)}`, 'loss');
          addLog(`‚ö° Waiting for digit ${entryDigit} to re-enter with Martingale...`, 'trade');
        }
        
        // Martingale: Double the stake for next trade
        state.currentStake = Math.min(state.currentStake * 2, parseFloat(document.getElementById('maxStake').value));
        
        updatePriceDisplay(entryDigit || '-', 'loss');
      }
      
      updateStats();
      
      // Check stop conditions
      const profitTarget = parseFloat(document.getElementById('profitTarget').value);
      const stopLoss = parseFloat(document.getElementById('stopLoss').value);
      
      if (state.totalProfit >= profitTarget) {
        addLog(`üéØ PROFIT TARGET REACHED! Stopping trading.`, 'win');
        stopTrading();
      } else if (state.totalProfit <= -stopLoss) {
        addLog(`üí• STOP LOSS REACHED! Stopping trading.`, 'loss');
        stopTrading();
      } else if (state.currentReentries > state.maxReentries) {
        addLog(`üö´ MAX RE-ENTRIES (${state.maxReentries}) REACHED! Stopping trading.`, 'loss');
        stopTrading();
      }
    }

    // Control Functions
    function startTrading() {
      state.token = document.getElementById('apiToken').value.trim();
      state.market = document.getElementById('marketSelect').value;
      state.tradeType = document.getElementById('tradeDirection').value;
      state.barrier = parseInt(document.getElementById('tradeBarrier').value);
      state.patternCount = parseInt(document.getElementById('patternCount').value);
      state.baseStake = parseFloat(document.getElementById('baseStake').value);
      state.currentStake = state.baseStake;
      
      if (!state.token) {
        addLog('Please enter your Deriv API token', 'info');
        return;
      }
      
      state.isTrading = true;
      state.patternProgress = 0;
      state.currentReentries = 0;
      state.consecutiveLosses = 0;
      state.lastLossDigit = null;
      state.recentDigits = [];
      
      addLog(`üöÄ STARTING TRADING: ${document.getElementById('marketSelect').selectedOptions[0].text}`, 'trade');
      addLog(`Strategy: ${state.tradeType === 'DIGITOVER' ? 'Over' : 'Under'} ${state.barrier} after ${state.patternCount} consecutive patterns`, 'info');
      addLog(`Martingale: Immediate re-entry on loss with 2x stake (Max ${state.maxReentries} re-entries)`, 'info');
      
      if (!state.isConnected) {
        connectWebSocket();
      } else {
        state.ws.send(JSON.stringify({
          ticks: state.market,
          subscribe: 1
        }));
      }
      
      updateStats();
    }

    function stopTrading() {
      state.isTrading = false;
      state.patternProgress = 0;
      state.currentReentries = 0;
      state.lastLossDigit = null;
      addLog('üõë TRADING STOPPED', 'info');
    }

    function testTrade() {
      if (!state.isConnected) {
        addLog('Please connect first by starting trading', 'info');
        return;
      }
      addLog('üîß MANUAL TEST TRADE TRIGGERED', 'trade');
      placeTrade('MANUAL_TEST');
    }

    // Initialize
    initCandlestickBackground();
    updateStats();
    addLog('Deriv Pro Trader initialized with Martingale re-entry system!', 'info');
    
    // Update market display when selection changes
    document.getElementById('marketSelect').addEventListener('change', updateStats);
  </script>
</body>
</html>